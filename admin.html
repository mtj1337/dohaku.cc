<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>dohaku - Admin Panel</title>
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
  <style>
    :root {
      --primary-bg: #ffffff;
      --light-gray: #e0e0e0;
      --text-gray: #666;
      --shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }

    body {
      font-family: 'Montserrat', sans-serif;
      background-color: var(--primary-bg);
      color: #222;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .navbar {
      box-shadow: var(--shadow);
    }

    .navbar-brand img {
      height: 40px;
    }

    .event-item {
      background-color: var(--light-gray);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
    }

    .no-events {
      color: var(--text-gray);
      font-style: italic;
      text-align: center;
      padding: 20px 0;
    }

    .btn:disabled {
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand navbar-light bg-white sticky-top">
    <div class="container-fluid px-4">
      <a class="navbar-brand" href="index.html">
        <img src="logo.png" alt="Logo">
      </a>
      <div class="ms-auto">
        <button id="logout-btn" class="btn btn-dark btn-sm">Odhlásit se</button>
      </div>
    </div>
  </nav>

  <main class="container py-4">
    <h2 class="mb-4">Admin Panel</h2>

    <div class="card shadow-sm mb-4">
      <div class="card-body">
        <h5 class="card-title">Vítejte v Admin Panelu</h5>
        <p class="card-text">Eventy se automaticky ukládají na GitHub a publikují na web.</p>
      </div>
    </div>

    <div class="card shadow-sm mb-4">
      <div class="card-body">
        <h5 class="card-title">Správa webu</h5>
        <p class="card-text">Zde můžete spravovat obsah a nastavení vašeho webu.</p>
        <button id="create-page-btn" class="btn btn-dark w-100">Vytvořit nový event</button>
      </div>
    </div>

    <div class="card shadow-sm mb-4">
      <div class="card-body">
        <h5 class="card-title">Správa eventů</h5>
        <p class="card-text">Zobrazte a spravujte všechny eventy v kalendáři.</p>
        <div class="d-flex justify-content-end mb-3">
          <button id="refresh-events-btn" class="btn btn-outline-secondary btn-sm">Refresh</button>
        </div>
        <div id="events-list">
          <p class="no-events">Načítání eventů...</p>
        </div>
      </div>
    </div>
  </main>

  <!-- Modal for creating new page -->
  <div class="modal fade" id="page-creator-modal" tabindex="-1" aria-labelledby="pageCreatorModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="pageCreatorModalLabel">Vytvořit novou Event stránku</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="page-creator-form">
            <div class="mb-3">
              <label for="page-name" class="form-label">Název stránky (URL bude [name].html):</label>
              <input type="text" class="form-control" id="page-name" required placeholder="e.g. teplice">
            </div>

            <div class="mb-3">
              <label for="event-title" class="form-label">Název Eventu:</label>
              <input type="text" class="form-control" id="event-title" required placeholder="e.g. teplice">
            </div>

            <div class="mb-3">
              <label for="event-date" class="form-label">Datum a čas Eventu:</label>
              <input type="text" class="form-control" id="event-date" required placeholder="e.g. neděle 8. června 13:00">
            </div>

            <div class="mb-3">
              <label for="event-start" class="form-label">Místo startu:</label>
              <input type="text" class="form-control" id="event-start" required placeholder="e.g. západní nádraží">
            </div>

            <div class="mb-3">
              <label for="event-length" class="form-label">Délka:</label>
              <input type="text" class="form-control" id="event-length" required placeholder="e.g. 60km">
            </div>

            <div class="mb-3">
              <label for="event-elevation" class="form-label">Převýšení:</label>
              <input type="text" class="form-control" id="event-elevation" required placeholder="e.g. 500m">
            </div>

            <div class="mb-3">
              <label for="event-pace" class="form-label">Tempo:</label>
              <input type="text" class="form-control" id="event-pace" required placeholder="e.g. social pace">
            </div>

            <div class="mb-3">
              <label for="event-coffee" class="form-label">Coffee Stop:</label>
              <input type="text" class="form-control" id="event-coffee" required placeholder="e.g. teplice/unl">
            </div>

            <div class="mb-3">
              <label for="route-url" class="form-label">URL mapy trasy:</label>
              <input type="url" class="form-control" id="route-url" required placeholder="e.g. https://mapy.com/s/kehuneguro">
            </div>

            <button type="submit" class="btn btn-dark w-100" id="submit-btn">
              <span id="submit-text">Vytvořit stránku</span>
              <span id="submit-spinner" class="spinner-border spinner-border-sm d-none" role="status"></span>
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal for editing event -->
  <div class="modal fade" id="event-editor-modal" tabindex="-1" aria-labelledby="eventEditorModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="eventEditorModalLabel">Upravit Event</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="event-editor-form">
            <input type="hidden" id="edit-event-index">

            <div class="mb-3">
              <label for="edit-page-name" class="form-label">Název stránky:</label>
              <input type="text" class="form-control" id="edit-page-name" required placeholder="e.g. teplice" readonly>
              <small class="form-text text-muted">Název stránky nelze změnit</small>
            </div>

            <div class="mb-3">
              <label for="edit-event-title" class="form-label">Název Eventu:</label>
              <input type="text" class="form-control" id="edit-event-title" required placeholder="e.g. teplice">
            </div>

            <div class="mb-3">
              <label for="edit-event-date" class="form-label">Datum a čas Eventu:</label>
              <input type="text" class="form-control" id="edit-event-date" required placeholder="e.g. neděle 8. června 13:00">
            </div>

            <div class="mb-3">
              <label for="edit-event-start" class="form-label">Místo startu:</label>
              <input type="text" class="form-control" id="edit-event-start" required placeholder="e.g. západní nádraží">
            </div>

            <div class="mb-3">
              <label for="edit-event-length" class="form-label">Délka:</label>
              <input type="text" class="form-control" id="edit-event-length" required placeholder="e.g. 60km">
            </div>

            <div class="mb-3">
              <label for="edit-event-elevation" class="form-label">Převýšení:</label>
              <input type="text" class="form-control" id="edit-event-elevation" required placeholder="e.g. 500m">
            </div>

            <div class="mb-3">
              <label for="edit-event-pace" class="form-label">Tempo:</label>
              <input type="text" class="form-control" id="edit-event-pace" required placeholder="e.g. social pace">
            </div>

            <div class="mb-3">
              <label for="edit-event-coffee" class="form-label">Coffee Stop:</label>
              <input type="text" class="form-control" id="edit-event-coffee" required placeholder="e.g. teplice/unl">
            </div>

            <div class="mb-3">
              <label for="edit-route-url" class="form-label">URL mapy trasy:</label>
              <input type="url" class="form-control" id="edit-route-url" required placeholder="e.g. https://mapy.com/s/kehuneguro">
            </div>

            <button type="submit" class="btn btn-dark w-100">Uložit změny</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    toastr.options = {
      closeButton: true,
      progressBar: true,
      positionClass: "toast-top-right",
      timeOut: 5000
    };

    document.addEventListener('DOMContentLoaded', function() {
      checkAuthentication();

      document.getElementById('logout-btn').addEventListener('click', function() {
        localStorage.removeItem('isAuthenticated');
        window.location.href = 'login.html';
      });

      document.getElementById('create-page-btn').addEventListener('click', function() {
        openCreateModal();
      });

      document.getElementById('refresh-events-btn').addEventListener('click', function() {
        loadEvents();
        toastr.info('Seznam eventů byl obnoven');
      });

      document.getElementById('page-creator-form').addEventListener('submit', handlePageCreation);

      loadEvents();
    });

    async function deleteEvent(index) {
      if (!confirm('Opravdu chcete smazat tento event?')) {
        return;
      }

      try {
        const events = JSON.parse(localStorage.getItem('calendarEvents') || '[]');
        const event = events[index];

        toastr.info('Mazání eventu...');

        const response = await fetch('/api/delete-event', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            eventIndex: index,
            pageName: event.pageName
          })
        });

        const result = await response.json();

        if (response.ok) {
          toastr.success('Event byl úspěšně smazán!');
          // Refresh events after short delay to allow GitHub to update
          setTimeout(() => {
            loadEvents();
          }, 2000);
        } else {
          throw new Error(result.error || 'Nepodařilo se smazat event');
        }
      } catch (error) {
        console.error('Chyba při mazání eventu:', error);
        toastr.error('Chyba: ' + error.message);
      }
    }

    function loadEvents() {
      const eventsListContainer = document.getElementById('events-list');
      eventsListContainer.innerHTML = '<p class="no-events">Načítání událostí...</p>';

      fetch('events.json?cachebust=' + new Date().getTime())
        .then(response => {
          if (!response.ok) {
            throw new Error('Nelze načíst events.json ze serveru');
          }
          return response.json();
        })
        .then(serverEvents => {
          localStorage.setItem('calendarEvents', JSON.stringify(serverEvents));
          displayEvents(serverEvents, eventsListContainer);
          console.log('Události úspěšně načteny z events.json');
        })
        .catch(error => {
          console.error('Chyba při načítání eventů ze serveru:', error);
          let events = [];
          try {
            events = JSON.parse(localStorage.getItem('calendarEvents') || '[]');
            displayEvents(events, eventsListContainer);
            toastr.warning('Události byly načteny pouze z lokálního úložiště.');
          } catch (error) {
            console.error('Chyba při načítání eventů z localStorage:', error);
            eventsListContainer.innerHTML = '<p class="no-events">Chyba při načítání eventů.</p>';
          }
        });
    }

    function displayEvents(events, container) {
      if (events.length === 0) {
        container.innerHTML = '<p class="no-events">Žádné eventy nenalezeny. Vytvořte event, aby se zde zobrazil.</p>';
        return;
      }

      events.sort((a, b) => {
        if (a.year !== b.year) return a.year - b.year;
        if (a.month !== b.month) return a.month - b.month;
        return a.day - b.day;
      });

      container.innerHTML = '';

      const monthNames = [
        'Leden', 'Únor', 'Březen', 'Duben', 'Květen', 'Červen',
        'Červenec', 'Srpen', 'Září', 'Říjen', 'Listopad', 'Prosinec'
      ];

      events.forEach((event, index) => {
        const eventItem = document.createElement('div');
        eventItem.className = 'event-item d-flex justify-content-between align-items-center';

        eventItem.innerHTML = `
          <div class="event-info">
            <div class="fw-semibold mb-1">${event.title}</div>
            <div class="text-muted small">${event.day}. ${monthNames[event.month]} ${event.year} - ${event.pageName}.html</div>
          </div>
          <div class="event-actions d-flex gap-2">
            <button class="btn btn-danger btn-sm" onclick="deleteEvent(${index})">Smazat</button>
          </div>
        `;

        container.appendChild(eventItem);
      });
    }

    async function checkAuthentication() {
      const isAuthenticated = localStorage.getItem('isAuthenticated');

      if (!isAuthenticated) {
        try {
          const response = await fetch('credentials.json');
          if (!response.ok) {
            redirectToLogin();
            return;
          }
          redirectToLogin();
        } catch (error) {
          console.error('Chyba při kontrole přihlášení:', error);
          redirectToLogin();
        }
      }
    }

    function redirectToLogin() {
      window.location.href = 'login.html';
    }

    function openCreateModal() {
      const modal = new bootstrap.Modal(document.getElementById('page-creator-modal'));
      document.getElementById('page-creator-form').reset();
      modal.show();
    }

    function generateEventHtml(pageName, eventData) {
      return '<!DOCTYPE html>\n' +
'<html lang="cs">\n' +
'<head>\n' +
'  <meta charset="UTF-8" />\n' +
'  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>\n' +
'  <title>dohaku - ' + pageName + '</title>\n' +
'  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">\n' +
'  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">\n' +
'  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">\n' +
'  <link rel="manifest" href="/site.webmanifest">\n' +
'  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet" />\n' +
'  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">\n' +
'  <style>\n' +
'    :root { --bg: #f9f9f9; --text: #222; --shadow: 0 2px 6px rgba(0, 0, 0, 0.1); }\n' +
'    body { font-family: "Montserrat", sans-serif; background-color: #ffffff; color: #222; min-height: 100vh; display: flex; flex-direction: column; }\n' +
'    .navbar { box-shadow: var(--shadow); }\n' +
'    .navbar-brand img { height: 40px; }\n' +
'    .social-icons a img { width: 28px; height: 28px; object-fit: contain; transition: transform 0.2s; }\n' +
'    .social-icons a:hover img { transform: scale(1.1); }\n' +
'    .info-box { background-color: var(--bg); padding: 25px; border-radius: 15px; box-shadow: var(--shadow); height: 100%; }\n' +
'    .info-box h2 { margin-top: 0; font-size: 24px; text-align: center; text-transform: lowercase; }\n' +
'    .info-box p { font-size: 16px; margin: 8px 0; }\n' +
'    .route-container { background-color: var(--bg); padding: 25px; border-radius: 15px; box-shadow: var(--shadow); height: 100%; }\n' +
'    .route-title { font-size: 24px; text-align: center; text-transform: lowercase; margin-bottom: 15px; }\n' +
'    .responsive-iframe { position: relative; width: 100%; padding-bottom: 52.02%; height: 0; overflow: hidden; border-radius: 15px; box-shadow: var(--shadow); }\n' +
'    .responsive-iframe iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0; }\n' +
'    .slogan h1 { font-size: 64px; letter-spacing: 4px; margin: 0; color: #222; }\n' +
'    @media (max-width: 768px) { .slogan { display: none; } }\n' +
'  </style>\n' +
'</head>\n' +
'<body>\n' +
'<nav class="navbar navbar-expand navbar-light bg-white sticky-top">\n' +
'  <div class="container-fluid px-4">\n' +
'    <a class="navbar-brand" href="index.html"><img src="logo.png" alt="Logo"></a>\n' +
'    <div class="social-icons d-flex gap-2">\n' +
'      <a href="https://www.strava.com/clubs/1535566" target="_blank"><img src="strava.png" alt="Strava"></a>\n' +
'      <a href="https://www.instagram.com/dohaku.cc" target="_blank"><img src="instagram.png" alt="Instagram"></a>\n' +
'      <a href="https://www.tiktok.com/@dohaku.cc" target="_blank"><img src="tiktok.png" alt="TikTok"></a>\n' +
'    </div>\n' +
'  </div>\n' +
'</nav>\n' +
'<main class="flex-grow-1">\n' +
'  <div class="container-fluid py-4 px-4">\n' +
'    <div class="row g-4">\n' +
'      <div class="col-lg-6">\n' +
'        <div class="info-box">\n' +
'          <h2>' + pageName + '</h2>\n' +
'          <p><strong>' + eventData.date + '</strong></p>\n' +
'          <p><strong>start</strong> ' + eventData.start + '</p>\n' +
'          <p><strong>lenght</strong> ' + eventData.length + '</p>\n' +
'          <p><strong>elevation</strong> ' + eventData.elevation + '</p>\n' +
'          <p><strong>pace</strong> ' + eventData.pace + '</p>\n' +
'          <p><strong>coffee stop</strong> ' + eventData.coffee + '</p>\n' +
'        </div>\n' +
'      </div>\n' +
'      <div class="col-lg-6">\n' +
'        <div class="route-container">\n' +
'          <div class="route-title"><strong>trasa</strong></div>\n' +
'          <div class="responsive-iframe">\n' +
'            <iframe src="' + eventData.routeUrl + '" allowfullscreen></iframe>\n' +
'          </div>\n' +
'        </div>\n' +
'      </div>\n' +
'    </div>\n' +
'  </div>\n' +
'  <div class="slogan text-center py-5">\n' +
'    <h1>ride | discover | belong</h1>\n' +
'  </div>\n' +
'</main>\n' +
'<footer class="bg-light text-center py-2 mt-auto">\n' +
'  <small class="text-muted">&copy; 2025 dohaku.cc | All rights reserved.</small>\n' +
'</footer>\n' +
'<scr' + 'ipt src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></scr' + 'ipt>\n' +
'</body>\n' +
'</html>';
    }

    async function handlePageCreation(e) {
      e.preventDefault();

      const submitBtn = document.getElementById('submit-btn');
      const submitText = document.getElementById('submit-text');
      const submitSpinner = document.getElementById('submit-spinner');

      // Disable button and show spinner
      submitBtn.disabled = true;
      submitText.textContent = 'Ukládám na GitHub...';
      submitSpinner.classList.remove('d-none');

      const pageName = document.getElementById('page-name').value;
      const eventTitle = document.getElementById('event-title').value;
      const eventDate = document.getElementById('event-date').value;
      const eventStart = document.getElementById('event-start').value;
      const eventLength = document.getElementById('event-length').value;
      const eventElevation = document.getElementById('event-elevation').value;
      const eventPace = document.getElementById('event-pace').value;
      const eventCoffee = document.getElementById('event-coffee').value;
      const routeUrl = document.getElementById('route-url').value;

      // Parse date
      let day = new Date().getDate();
      let month = new Date().getMonth();
      let year = new Date().getFullYear();

      try {
        const dateMatch = eventDate.match(/(\d+)\.\s*([^\s]+)\s*(\d+)?/);
        if (dateMatch) {
          day = parseInt(dateMatch[1]);
          const monthNames = [
            'ledna', 'února', 'března', 'dubna', 'května', 'června',
            'července', 'srpna', 'září', 'října', 'listopadu', 'prosince',
            'leden', 'únor', 'březen', 'duben', 'květen', 'červen',
            'červenec', 'srpen', 'září', 'říjen', 'listopad', 'prosinec'
          ];
          const monthIndex = monthNames.findIndex(m => m.toLowerCase() === dateMatch[2].toLowerCase());
          if (monthIndex !== -1) {
            month = monthIndex % 12;
          }
          if (dateMatch[3]) {
            year = parseInt(dateMatch[3]);
          }
        }
      } catch (error) {
        console.error('Chyba při parsování data:', error);
      }

      const event = {
        pageName: pageName,
        title: eventTitle,
        day: day,
        month: month,
        year: year
      };

      const eventData = {
        title: eventTitle,
        date: eventDate,
        start: eventStart,
        length: eventLength,
        elevation: eventElevation,
        pace: eventPace,
        coffee: eventCoffee,
        routeUrl: routeUrl
      };

      const eventHtml = generateEventHtml(pageName, eventData);

      try {
        const response = await fetch('/api/create-event', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            event: event,
            eventHtml: eventHtml,
            pageName: pageName
          })
        });

        const result = await response.json();

        if (response.ok) {
          toastr.success('Event byl úspěšně vytvořen a publikován na GitHub!');
          bootstrap.Modal.getInstance(document.getElementById('page-creator-modal')).hide();

          // Refresh events after short delay to allow GitHub to update
          setTimeout(() => {
            loadEvents();
            toastr.info('Web se aktualizuje během několika sekund...');
          }, 2000);
        } else {
          throw new Error(result.error || 'Nepodařilo se vytvořit event');
        }
      } catch (error) {
        console.error('Chyba:', error);
        toastr.error('Chyba: ' + error.message);
      } finally {
        // Re-enable button
        submitBtn.disabled = false;
        submitText.textContent = 'Vytvořit stránku';
        submitSpinner.classList.add('d-none');
      }
    }
  </script>
</body>
</html>
